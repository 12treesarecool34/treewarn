<!DOCTYPE html>
<html lang="en">

<head>
    <title>SparkGen</title>
    <link rel="icon" href="https://raw.githubusercontent.com/busybird15/busybird15.github.io/main/beta/sparkradar/logo-rounded.png" />

    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">

    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.7.1/leaflet.css" />
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/leaflet.draw/1.0.2/leaflet.draw.css" />
    <script src="https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.7.1/leaflet.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/leaflet.draw/1.0.2/leaflet.draw.js"></script>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/Turf.js/5.1.6/turf.min.js"></script>

    <script src="https://cdn.maptiler.com/maptiler-sdk-js/v2.0.3/maptiler-sdk.umd.js"></script>
    <link href="https://cdn.maptiler.com/maptiler-sdk-js/v2.0.3/maptiler-sdk.css" rel="stylesheet" />
    <script src="https://cdn.maptiler.com/leaflet-maptilersdk/v2.0.0/leaflet-maptilersdk.js"></script>

    <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:opsz,wght,FILL,GRAD@20..48,100..700,0..1,-50..200" />
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Outfit:wght@100..900&display=swap" rel="stylesheet">

    <style>
        * {
            font-family: 'Outfit', sans-serif;
        }

        body {
            overflow: hidden;
            margin: 0;
        }

        #mapid {
            z-index: 1;
            width: 100vw;
            height: 100vh;
            position: absolute;
            top: 0px;
            left: 0px;
        }
        
        .context-menu {
            display: none;
            position: absolute;
            z-index: 10000;
            width: max-content;
            overflow: hidden;
            background-color: #fff;
            box-shadow: 0px 0px 10px rgba(0, 0, 0, 0.5);
            border-radius: 10px;
        }

        .context-menu ul {
            list-style: none;
            padding: 0;
            margin: 0;
        }

        .context-menu ul li {
            display: flex;
            align-items: center;
            padding: 10px;
            cursor: pointer;
        }

        .context-menu .material-symbols-outlined {
            padding-right: 10px;
        }

        .context-menu ul li:hover {
            background-color: #eee;
        }

        button {
            padding: 4px;
            margin: 8px;
            background: rgb(254, 22, 103);
            color: black;
            border-radius: 5px;
            border: none;
            cursor: pointer;
            font-size: large;
            width: 100px;
        }

        button:hover {
            background: rgb(255, 80, 120);
        }

        select {
            padding: 5px;
            border: none;
            border-radius: 20px;
            cursor: pointer;
            font-size: large;
        }

        .editable-overlay {
            position: absolute;
            top: 10px;
            right: 10px;
            z-index: 1001;
            padding: 10px;
            color: white;
            background: rgba(20, 20, 20, 0.6);
            backdrop-filter: blur(10px);
            -webkit-backdrop-filter: blur(10px);
            border-radius: 5px;
            width: fit-content;
            height: fit-content;
            max-width: calc(100vw - 20px);
            max-height: calc(100vh - 40px);
            overflow: hidden;
        }

        .editable-overlay h2,
        .editable-overlay p {
            margin-top: 0;
            margin-bottom: 0;
            padding: 5px;
            border: 1px solid transparent;
            white-space: pre-wrap;
            overflow: hidden;
        }

        .editable-overlay h2:hover,
        .editable-overlay p:hover {
            background-color: rgba(255, 255, 255, 0.1);
            cursor: pointer;
        }

        .editable-overlay h2:focus,
        .editable-overlay p:focus {
            border: 1px dashed white;
            outline: none;
        }
    </style>
</head>

<body>
    <div id="content">
        <div id="mapid"></div>

        <div class="editable-overlay" id="editableOverlay">
            <h2 contenteditable="true" spellcheck="false">Alert Title</h2>
            <p contenteditable="true" spellcheck="false">Alert Text</p>
        </div>

        <div id="loader" style="z-index: 100; flex-direction: column; position: absolute; top: 0; left: 0; width: 100%; height: 100%; background: black; color: white; display: flex; align-items: center; justify-content: center;">
            <h2>Loading...</h2>
            <p style="width: 70%; text-align: center;">We're downloading the county database. This may take some time but only needs to be done once.</p>
        </div>

        <div id="style" style="z-index: 100; overflow-y: auto; position: absolute; top: 0; left: 0; width: 100%; height: 100%; background: rgb(20, 20, 20, 0.6); backdrop-filter: blur(10px); -webkit-backdrop-filter: blur(10px); color: white; display: none;">
            <div style="display: flex; flex-direction: column; width: 100%; max-width: 100%; padding: 20px; box-sizing: border-box;">
                <h1>Settings</h1>
                <div style="display: flex; flex-direction: row; align-items: center;">
                    <input onchange="changemap();" type="checkbox"> Use light maps
                </div>
                <h3>Styles</h3>
                <div style="display: flex; flex-direction: column; align-items: left;">
                    <div style="display: flex; flex-direction: row; align-items: center;">
                        <p style="margin: 0px 10px 0px 0px;">Color: </p>
                        <select id="stylePreset" style="min-width: 150px;">
                            <option value="custom">Custom</option>
                            <option value="#FF0000">Tornado</option>
                            <option value="#FFA500">Severe</option>
                            <option value="#ADD8E6">Statement</option>
                            <option value="#FFFF00">Tropical</option>
                            <option value="#008080">Flash Flood</option>
                            <option value="#008000">Flood</option>
                            <option value="#8B0000">Tornado Watch</option>
                            <option value="#556B2F">Severe Watch</option>
                            <option value="#0000FF">Discussion</option>
                        </select>
                    </div>
                    <div id="customColorPicker" style="display: flex; flex-direction: row; align-items: center; margin-top: 10px;">
                        <p style="margin: 0px 10px 0px 0px;">Custom Color: </p>
                        <input id="styleColor" type="color" value="#000000">
                    </div>
                    <br>
                    <div style="display: flex; flex-direction: row; align-items: center;">
                        <p style="margin: 0px 10px 0px 0px;">Level: </p>
                        <select id="levelPreset" style="min-width: 150px;">
                            <option value="standard">Standard</option>
                            <option value="considerable">Considerable</option>
                            <option value="destructive">Destructive</option>
                            <option value="pds">Particularly Dangerous</option>
                            <option value="emergency">Emergency</option>
                        </select>
                    </div>
                    <div style="display: flex; flex-direction: row; gap: 10px; margin-top: 20px;">
                        <button id="closeSettings">Close</button>
                    </div>
                </div>
            </div>
        </div>

        <div id="about" style="z-index: 100; overflow-y: auto; position: absolute; top: 0; left: 0; width: 100%; height: 100%; background: rgb(20, 20, 20, 0.6); backdrop-filter: blur(10px); -webkit-backdrop-filter: blur(10px); color: white; display: none;">
            <div style="display: flex; flex-direction: column; width: 100%; max-width: 100%; padding: 20px; box-sizing: border-box;">
                <h1>About SparkGen</h1>
                <p>SparkGen is a simple tool for creating and visualizing your own weather alerts.</p>
                <p>This is a modified version of the <a href="https://busybird15.github.io/sparkgen">original SparkGen</a>, which was made by <a href="https://busybird15.github.io/">BusyBird15</a>.</p>
                <div style="display: flex; flex-direction: row; gap: 10px; margin-top: 20px;">
                    <button id="closeAbout">Close</button>
                </div>
            </div>
        </div>

        <div id="custom-context-menu" class="context-menu">
            <ul>
                <li id="menu-item-1"><i class="material-symbols-outlined">add</i>New</li>
                <li id="menu-item-2"><i class="material-symbols-outlined">settings</i>Settings</li>
                <li id="menu-item-3"><i class="material-symbols-outlined">info</i>About</li>
                <li id="menu-item-4"><i class="material-symbols-outlined">edit</i>Edit</li>
                <li id="menu-item-5"><i class="material-symbols-outlined">delete</i>Delete</li>
            </ul>
        </div>

        <div id="sizer" style="font-size: larger; z-index: 1000; justify-content: center; flex-direction: row; position: absolute; top: 0px; left: 0px; width: 100%; height: 100%; background: rgb(20, 20, 20, 0.6); backdrop-filter: blur(10px); -webkit-backdrop-filter: blur(10px); color: white; display: none; align-items: center;">
            200x200
        </div>
    </div>

    <script>
        var map = L.map(document.getElementById("mapid"), {
            preferCanvas: true,
            doubleClickZoom: false,
            attributionControl: true,
            zoomControl: false,
            zoomSnap: 0,
            minZoom: 2
        }).setView([38.0, -100.4], 4);

        var southWest = L.latLng(-85, -180);
        var northEast = L.latLng(85, 180);
        var bounds = L.latLngBounds(southWest, northEast);
        map.setMaxBounds(bounds);
        map.on('drag', function() {
            map.panInsideBounds(bounds, { animate: false });
        });

        map.createPane('cities');
        map.getPane('cities').style.zIndex = 400;
        map.createPane('dashedLines');
        map.getPane('dashedLines').style.zIndex = 399;
        map.createPane('warnings');
        map.getPane('warnings').style.zIndex = 398;
        map.createPane('counties');
        map.getPane('counties').style.zIndex = 301;

        var emergencyDashesGroup = new L.FeatureGroup([], { pane: 'dashedLines' }).addTo(map);
        var warningsLayer = L.featureGroup([], { pane: 'warnings' }).addTo(map);
        var counties = L.geoJSON().addTo(map);

        L.drawLocal.draw.handlers.polygon.tooltip.start = null;
        L.drawLocal.draw.handlers.polygon.tooltip.cont = null;
        L.drawLocal.draw.handlers.polygon.tooltip.end = null;
        L.drawLocal.edit.handlers.edit.tooltip.text = null;
        L.drawLocal.edit.handlers.edit.tooltip.subtext = null;
        L.drawLocal.edit.handlers.remove.tooltip.text = null;

        var map_default = L.maptilerLayer({
            apiKey: "UMONrX6MjViuKZoR882u",
            style: '96084695-6598-45c9-8f28-a3e091d9275c',
        });
        var map_darkmaterial = L.maptilerLayer({
            apiKey: "UMONrX6MjViuKZoR882u",
            style: '6203b2a0-063f-44b0-95f7-8c69393a3a46',
        }).addTo(map);

        var currentMapLayer = map_darkmaterial;

        function changemap() {
            if (currentMapLayer) {
                map.removeLayer(currentMapLayer);
            }
            currentMapLayer = (currentMapLayer === map_default) ? map_darkmaterial : map_default;
            map.addLayer(currentMapLayer);
        }

        var clickColor = '#000000';
        var clickOpacity = 0.3;
        var isDrawing = false;
        var selectedPolygon = null;

        function reverseSubarrays(arr) {
            return arr.map(subArr => subArr.slice().reverse());
        }

        function perFeature(feature, layer) {
            layer.setStyle({
                color: 'black',
                fillOpacity: 0,
                weight: 2
            });
            layer.customColor = 'no';
        }

        fetch('https://busybird15.github.io/assets/countymaps/counties-simplified.json')
            .then(response => response.json())
            .then(data => {
                counties = L.geoJSON(data, {
                    onEachFeature: perFeature,
                    pane: 'counties'
                }).addTo(map);
                document.getElementById("loader").style.display = "none";
            })
            .catch(error => {
                console.error('Error loading GeoJSON data:', error);
            });

        var citylayer = L.maptilerLayer({
            apiKey: "UMONrX6MjViuKZoR882u",
            style: '3077107e-833d-4087-999c-3b42c3ec5b13',
            pane: "cities",
        }).addTo(map);
        citylayer.getContainer().style.pointerEvents = 'none';

        let x = 0;
        let y = 0;

        function rClick(e) {
            e.preventDefault();
            const menu = document.getElementById('custom-context-menu');
            menu.style.display = 'block';

            const menuWidth = menu.offsetWidth;
            const menuHeight = menu.offsetHeight;
            const windowWidth = window.innerWidth;
            const windowHeight = window.innerHeight;

            x = e.clientX;
            y = e.clientY;

            if (x + menuWidth > windowWidth) x = windowWidth - menuWidth;
            if (y + menuHeight > windowHeight) y = windowHeight - menuHeight;
            if (x < 0) x = 0;
            if (y < 0) y = 0;

            menu.style.left = `${x}px`;
            menu.style.top = `${y}px`;
        }
        document.addEventListener('contextmenu', rClick);

        document.getElementById('menu-item-1').addEventListener('click', function() {
            isDrawing = true;
            drawPolygon.enable();
            document.getElementById('custom-context-menu').style.display = 'none';
        });

        document.getElementById('menu-item-2').addEventListener('click', function() {
            document.getElementById('style').style.display = 'flex';
            document.getElementById('custom-context-menu').style.display = 'none';
        });

        document.getElementById('menu-item-3').addEventListener('click', function() {
            document.getElementById('about').style.display = 'flex';
            document.getElementById('custom-context-menu').style.display = 'none';
        });

        var featureGroupForEditing = new L.FeatureGroup().addTo(map);
        var currentEditHandler = null;

        document.getElementById('menu-item-4').addEventListener('click', function() {
            if (selectedPolygon && selectedPolygon.isCustomPolygon) {
                removeEmergencyDash(selectedPolygon);
                if (warningsLayer.hasLayer(selectedPolygon)) {
                    warningsLayer.removeLayer(selectedPolygon);
                } else if (counties.hasLayer(selectedPolygon)) {
                    counties.removeLayer(selectedPolygon);
                }
                featureGroupForEditing.addLayer(selectedPolygon);
                currentEditHandler = new L.EditToolbar.Edit(map, {
                    featureGroup: featureGroupForEditing
                });
                currentEditHandler.enable();
            }
            document.getElementById('custom-context-menu').style.display = 'none';
        });

        document.getElementById('menu-item-5').addEventListener('click', function() {
            if (selectedPolygon && selectedPolygon.isCustomPolygon) {
                removeEmergencyDash(selectedPolygon);
                if (warningsLayer.hasLayer(selectedPolygon)) {
                    warningsLayer.removeLayer(selectedPolygon);
                } else if (counties.hasLayer(selectedPolygon)) {
                    counties.removeLayer(selectedPolygon);
                }
            }
            document.getElementById('custom-context-menu').style.display = 'none';
        });

        var drawControl = new L.Control.Draw({ edit: false, draw: false });
        map.addControl(drawControl);

        var drawPolygon = new L.Draw.Polygon(map, drawControl.options.draw.polygon);

        map.on('draw:created', function(e) {
            isDrawing = false;
            var layer = e.layer;
            var polygon = L.polygon(reverseSubarrays(layer.toGeoJSON()['geometry']['coordinates'][0]), {
                color: 'black',
                pane: 'counties',
                fillOpacity: 0
            }).addTo(counties);
            polygon.customColor = 'no';
            polygon.isCustomPolygon = true;
        });

        map.on('draw:canceled', function(e) {
            isDrawing = false;
        });
        
        map.on(L.Draw.Event.EDITSTOP, function(e) {
            const layersToAddBack = [];
            featureGroupForEditing.eachLayer(layer => {
                layersToAddBack.push(layer);
                if (layer.customColor === 'yes' && layer.levelPreset === 'emergency') {
                    createEmergencyDash(layer);
                }
            });
            featureGroupForEditing.clearLayers();
            layersToAddBack.forEach(layer => {
                if (layer.customColor === 'yes') {
                    warningsLayer.addLayer(layer);
                } else {
                    counties.addLayer(layer);
                }
            });
            currentEditHandler = null;
        });

        map.on('contextmenu', function(e) {
            var clickedPoint = e.latlng;
            var clickedPointGeoJSON = turf.point([clickedPoint.lng, clickedPoint.lat]);
            var foundPolygon = false;
            selectedPolygon = null;

            var menuItem4 = document.getElementById('menu-item-4');
            var menuItem5 = document.getElementById('menu-item-5');

            var checkLayers = function(layer) {
                if (foundPolygon || !(layer instanceof L.Polygon)) return;
                if (turf.booleanPointInPolygon(clickedPointGeoJSON, layer.toGeoJSON())) {
                    foundPolygon = true;
                    selectedPolygon = layer;
                }
            };

            warningsLayer.getLayers().slice().reverse().forEach(checkLayers);
            if (!foundPolygon) {
                counties.getLayers().slice().reverse().forEach(checkLayers);
            }

            if (foundPolygon) {
                var isCustom = !!selectedPolygon.isCustomPolygon;
                menuItem4.style.display = isCustom ? 'flex' : 'none';
                menuItem5.style.display = isCustom ? 'flex' : 'none';
            } else {
                menuItem4.style.display = 'none';
                menuItem5.style.display = 'none';
            }
        });

        map.on('click', function(e) {
            var contextMenu = document.getElementById('custom-context-menu');
            if (contextMenu.style.display !== 'none') {
                contextMenu.style.display = 'none';
                return;
            }

            if (isDrawing || currentEditHandler) return;

            var clickedPoint = e.latlng;
            var clickedPointGeoJSON = turf.point([clickedPoint.lng, clickedPoint.lat]);
            var handled = false;

            var reversedWarnings = warningsLayer.getLayers().slice().reverse();
            reversedWarnings.forEach(function(layer) {
                if (handled || !(layer instanceof L.Polygon)) return;
                if (turf.booleanPointInPolygon(clickedPointGeoJSON, layer.toGeoJSON())) {
                    handled = true;
                    warningsLayer.removeLayer(layer);
                    removeEmergencyDash(layer);
                    layer.setStyle({ fillOpacity: 0, color: 'black', weight: 2 });
                    layer.customColor = 'no';
                    layer.levelPreset = null;
                    layer.baseColor = null;
                    delete layer.options.baseWeight;
                    counties.addLayer(layer);
                }
            });

            if (handled) return;

            var reversedCounties = counties.getLayers().slice().reverse();
            reversedCounties.forEach(function(layer) {
                if (handled || !(layer instanceof L.Polygon)) return;
                if (turf.booleanPointInPolygon(clickedPointGeoJSON, layer.toGeoJSON())) {
                    handled = true;
                    counties.removeLayer(layer);
                    layer.customColor = 'yes';
                    layer.levelPreset = document.getElementById('levelPreset').value;
                    layer.baseColor = clickColor;
                    layer.options.baseWeight = 2;
                    if (layer.levelPreset === 'emergency') {
                        createEmergencyDash(layer);
                    }
                    layer.setStyle({
                        fillOpacity: clickOpacity,
                        fillColor: layer.baseColor,
                        color: layer.baseColor,
                        weight: layer.options.baseWeight
                    });
                    warningsLayer.addLayer(layer);
                }
            });
        });

        document.addEventListener('keydown', function(e) {
            if (document.activeElement && (document.activeElement.isContentEditable || /INPUT|TEXTAREA|SELECT/.test(document.activeElement.tagName))) {
                return;
            }

            if (e.key === 'Enter') {
                e.preventDefault();
                if (isDrawing) drawPolygon.completeShape();
                if (currentEditHandler) {
                    currentEditHandler.save();
                    currentEditHandler.disable();
                }
            } else if (e.key === 'Escape') {
                e.preventDefault();
                if (isDrawing) {
                    drawPolygon.disable();
                    isDrawing = false;
                }
                if (currentEditHandler) {
                    currentEditHandler.revertLayers();
                    currentEditHandler.disable();
                }
            }
        });

        document.getElementById('closeSettings').addEventListener('click', () => document.getElementById('style').style.display = 'none');
        document.getElementById('closeAbout').addEventListener('click', () => document.getElementById('about').style.display = 'none');
        
        var timeouter = null;
        window.addEventListener('resize', function(event) {
            let vw = Math.max(document.documentElement.clientWidth || 0, window.innerWidth || 0);
            let vh = Math.max(document.documentElement.clientHeight || 0, window.innerHeight || 0);
            const sizer = document.getElementById("sizer");
            sizer.style.display = 'flex';
            sizer.innerHTML = "<b>" + vw + "</b> x <b>" + vh + "</b>";
            clearTimeout(timeouter);
            timeouter = setTimeout(() => { sizer.style.display = 'none'; }, 1500);
        });

        const editableOverlay = document.getElementById('editableOverlay');
        const loader = document.getElementById('loader');
        const styleMenu = document.getElementById('style');
        const aboutMenu = document.getElementById('about');

        function updateOverlayVisibility() {
            const isModalOpen = loader.style.display !== 'none' || styleMenu.style.display !== 'none' || aboutMenu.style.display !== 'none';
            editableOverlay.style.display = isModalOpen ? 'none' : 'block';
        }

        const observer = new MutationObserver(updateOverlayVisibility);
        const observerConfig = { attributes: true, attributeFilter: ['style'] };
        observer.observe(loader, observerConfig);
        observer.observe(styleMenu, observerConfig);
        observer.observe(aboutMenu, observerConfig);
        updateOverlayVisibility();

        const DEFAULT_OPACITY = 0.3;

        function updateCurrentStyle() {
            const presetSelect = document.getElementById('stylePreset');
            clickColor = (presetSelect.value === 'custom') 
                ? document.getElementById('styleColor').value 
                : presetSelect.value;
            clickOpacity = DEFAULT_OPACITY;
        }
        
        document.getElementById('stylePreset').addEventListener('change', function() {
            const customColorPicker = document.getElementById('customColorPicker');
            customColorPicker.style.display = (this.value === 'custom') ? 'flex' : 'none';
            if (this.value !== 'custom') {
                document.getElementById('styleColor').value = this.value;
            }
            updateCurrentStyle();
        });

        document.getElementById('styleColor').addEventListener('input', () => {
             if (document.getElementById('stylePreset').value === 'custom') {
                updateCurrentStyle();
            }
        });

        updateCurrentStyle();

        function getPulseSize(preset) {
            switch (preset) {
                case 'considerable': return 2;
                case 'destructive':  return 5;
                case 'pds':          return 8;
                case 'emergency':    return 8;
                default:             return 0;
            }
        }

        function createEmergencyDash(originalLayer) {
            removeEmergencyDash(originalLayer);
            var dashPoly = L.polygon(originalLayer.getLatLngs(), {
                color: 'white',
                weight: 4,
                fill: false,
                dashArray: '8, 24',
                interactive: false,
            });
            dashPoly.original_id = originalLayer._leaflet_id;
            emergencyDashesGroup.addLayer(dashPoly);
        }

        function removeEmergencyDash(originalLayer) {
            var layerToRemove = null;
            emergencyDashesGroup.eachLayer(function(dashLayer) {
                if (dashLayer.original_id === originalLayer._leaflet_id) {
                    layerToRemove = dashLayer;
                }
            });
            if (layerToRemove) {
                emergencyDashesGroup.removeLayer(layerToRemove);
            }
        }
        
        function animateAllPolygons() {
            const cycleDuration = 2000;
            const timeInCycle = Date.now() % cycleDuration;
            let amplitude = (timeInCycle < cycleDuration / 2) 
                ? (timeInCycle / (cycleDuration / 2)) 
                : ((cycleDuration - timeInCycle) / (cycleDuration / 2));

            warningsLayer.eachLayer(function(layer) {
                if (layer instanceof L.Polygon && layer.customColor === 'yes' && layer.levelPreset) {
                    const baseWeight = layer.options.baseWeight || 2;
                    const pulseSize = getPulseSize(layer.levelPreset);
                    if (pulseSize > 0) {
                        const newWeight = baseWeight + (pulseSize * amplitude);
                        layer.setStyle({ weight: newWeight });
                    }
                }
            });
        }
        
        setInterval(animateAllPolygons, 50);

    </script>
</body>

</html>
