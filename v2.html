<!DOCTYPE html>
<html>
<head>
    <title>TreeRadar</title>
    <link rel="icon" href="https://raw.githubusercontent.com/microsoft/fluentui-emoji/refs/heads/main/assets/Deciduous%20tree/3D/deciduous_tree_3d.png" />
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link href="https://unpkg.com/maplibre-gl@2.4.0/dist/maplibre-gl.css" rel="stylesheet" />
    <style>
        body { margin: 0; padding: 0; font-family: sans-serif; }
        #map { position: absolute; top: 0; bottom: 0; width: 100%; }
        #settings-panel { position: absolute; top: 10px; right: 10px; background: rgba(255, 255, 255, 0.95); padding: 15px; border-radius: 5px; z-index: 1; min-width: 240px; box-shadow: 0 2px 4px rgba(0,0,0,0.2); }
        #settings-panel h2 { margin-top: 0; margin-bottom: 10px; font-size: 1.2em; }
        .settings-group { margin-bottom: 15px; }
        .settings-group:last-child { margin-bottom: 0; }
        .settings-group h3 { margin-top: 0; margin-bottom: 10px; font-size: 1em; border-bottom: 1px solid #ccc; padding-bottom: 5px; }
        #settings-panel .control-label { display: block; margin-bottom: 5px; font-weight: bold; }
        #settings-panel label { display: block; margin-bottom: 8px; cursor: pointer; }
        #settings-panel input[type="checkbox"], #settings-panel input[type="radio"] { margin-right: 5px; vertical-align: middle; }
        #settings-panel select { width: 100%; padding: 5px; margin-top: 2px; border-radius: 3px; border: 1px solid #ccc; }
        .maplibregl-popup-content { font-family: sans-serif; padding: 10px; text-align: center; }
        .maplibregl-popup-content button {
            background-color: #007bff; color: white; border: none; padding: 5px 10px;
            margin: 3px; border-radius: 3px; cursor: pointer; display: block; width: 100%;
        }
        .maplibregl-popup-content button:hover { background-color: #0056b3; }
    </style>
</head>
<body>

    <div id="map"></div>

    <div id="settings-panel">
        <h2>Settings</h2>
        <div class="settings-group">
            <h3>Map Style</h3>
            <select id="map-style-select">
                <option value="dark">Dark</option>
                <option value="light">Light</option>
            </select>
        </div>
        <div class="settings-group">
            <h3>SPC Outlooks</h3>
            <label class="control-label" for="spc-day-select">Forecast Day</label>
            <select id="spc-day-select">
                <option value="none" selected>None</option>
                <option value="1">Day 1</option>
                <option value="2">Day 2</option>
                <option value="3">Day 3</option>
            </select>
            <div id="spc-type-container">
                 <label class="control-label" for="spc-type-select">Outlook Type</label>
                 <select id="spc-type-select"></select>
            </div>
        </div>
        <div class="settings-group">
            <h3>Other Overlays</h3>
            <label><input type="checkbox" id="radar-toggle" checked> Weather Radar</label>
            <label><input type="checkbox" id="alerts-toggle" checked> Alerts</label>
            <label><input type="checkbox" id="radar-sites-toggle" checked> Radar Sites</label>
        </div>
    </div>

    <script src="https://unpkg.com/maplibre-gl@2.4.0/dist/maplibre-gl.js"></script>
    <script>
        const map = new maplibregl.Map({
            container: 'map',
            style: 'https://basemaps.cartocdn.com/gl/dark-matter-gl-style/style.json',
            center: [-97, 39],
            zoom: 2.75,
            attributionControl: false
        });

        map.addControl(new maplibregl.AttributionControl({
            compact: true
        }));

        const layerIds = {
            radar: 'weather-radar-layer',
            alerts: 'alerts-layer',
            alertsBorder: 'alerts-border-layer',
            radarSites: 'nws-radar-sites-layer',
            singleSiteRadar: 'single-site-radar-layer',
            spc: {
                day1: { cat: 'spc-day1-cat', torn: 'spc-day1-torn', hail: 'spc-day1-hail', wind: 'spc-day1-wind' },
                day2: { cat: 'spc-day2-cat', torn: 'spc-day2-torn', hail: 'spc-day2-hail', wind: 'spc-day2-wind' },
                day3: { cat: 'spc-day3-cat', prob: 'spc-day3-prob' }
            }
        };
        
        let activeSiteIdForMenu = null;
        let activeSiteIdForData = null;
        let activeRadarProductCode = null;
        let currentPopup = null;

        const baseSpcLayerIds = Object.values(layerIds.spc).flatMap(day => Object.values(day));
        const allSpcLayerIds = baseSpcLayerIds.flatMap(id => [id, `${id}-border`]);

        const daySelect = document.getElementById('spc-day-select');
        const typeSelect = document.getElementById('spc-type-select');
        const typeContainer = document.getElementById('spc-type-container');

        const outlookTypes = {
            day1: [{ value: 'cat', text: 'Categorical' }, { value: 'torn', text: 'Tornado' }, { value: 'hail', text: 'Hail' }, { value: 'wind', text: 'Wind' }],
            day2: [{ value: 'cat', text: 'Categorical' }, { value: 'torn', text: 'Tornado' }, { value: 'hail', text: 'Hail' }, { value: 'wind', text: 'Wind' }],
            day3: [{ value: 'cat', text: 'Categorical' }, { value: 'prob', text: 'Probabilistic' }]
        };
        
        function removeSingleSiteLayer() {
            if (map.getLayer(layerIds.singleSiteRadar)) map.removeLayer(layerIds.singleSiteRadar);
            if (map.getSource('single-site-radar-source')) map.removeSource('single-site-radar-source');
        }

        function closeActivePopup() {
            if (currentPopup) {
                currentPopup.remove();
                currentPopup = null;
            }
            activeSiteIdForMenu = null;
        }

        function toggleRadarProduct(stationId, productCode) {
            if (activeSiteIdForData === stationId && activeRadarProductCode === productCode) {
                removeSingleSiteLayer();
                activeRadarProductCode = null;
                activeSiteIdForData = null;
                return;
            }

            removeSingleSiteLayer(); 

            activeRadarProductCode = productCode;
            activeSiteIdForData = stationId;

            const productLayer = `${stationId}_${productCode}`;
            const tileUrl = `https://opengeo.ncep.noaa.gov/geoserver/${stationId}/ows?service=WMS&version=1.3.0&request=GetMap&layers=${productLayer}&styles=&format=image/png&transparent=true&width=256&height=256&crs=EPSG:3857&bbox={bbox-epsg-3857}`;

            map.addSource('single-site-radar-source', {
                'type': 'raster', 'tiles': [tileUrl], 'tileSize': 256, 'attribution': 'Radar data from NOAA'
            });

            // MODIFIED: Place the single-site radar layer on top of the IEM mosaic but below the alerts.
            map.addLayer({
                'id': layerIds.singleSiteRadar, 'type': 'raster', 'source': 'single-site-radar-source', 'paint': {}
            }, layerIds.alerts);
        }

        function updateAlerts() {
            if (!map.getSource('alerts')) return;
            fetch('https://api.weather.gov/alerts/active?status=actual&message_type=alert,update')
                .then(response => response.json())
                .then(data => {
                    if (map.getSource('alerts')) {
                        map.getSource('alerts').setData(data);
                    }
                }).catch(e => console.error("Alerts Fetch ERR:", e));
        }

        function updateRadar() {
            // This function refreshes the IEM mosaic source to get the latest data.
            // It is simplified to just update the source URL timestamp.
             if (map.getSource('weather-radar')) {
                map.getSource('weather-radar').setTiles([
                    `https://mesonet.agron.iastate.edu/cgi-bin/wms/nexrad/n0q.cgi?service=WMS&version=1.1.1&request=GetMap&layers=nexrad-n0q-900913&srs=EPSG:900913&width=256&height=256&format=image/png&transparent=true&bbox={bbox-epsg-3857}&_=${new Date().getTime()}`
                ]);
            }
        }

        function setupMapData() {
            if (map.getSource('weather-radar')) return;

            // Find the ID of the first symbol layer (map labels) to insert other layers before it.
            let firstSymbolId;
            for (const layer of map.getStyle().layers) {
                if (layer.type === 'symbol') {
                    firstSymbolId = layer.id;
                    break;
                }
            }

            // --- Add all data sources ---
            const spcSources = [
                { id: layerIds.spc.day1.cat, url: 'https://www.spc.noaa.gov/products/outlook/day1otlk_cat.nolyr.geojson' }, { id: layerIds.spc.day1.torn, url: 'https://www.spc.noaa.gov/products/outlook/day1otlk_torn.nolyr.geojson' }, { id: layerIds.spc.day1.hail, url: 'https://www.spc.noaa.gov/products/outlook/day1otlk_hail.nolyr.geojson' }, { id: layerIds.spc.day1.wind, url: 'https://www.spc.noaa.gov/products/outlook/day1otlk_wind.nolyr.geojson' },
                { id: layerIds.spc.day2.cat, url: 'https://www.spc.noaa.gov/products/outlook/day2otlk_cat.nolyr.geojson' }, { id: layerIds.spc.day2.torn, url: 'https://www.spc.noaa.gov/products/outlook/day2otlk_torn.nolyr.geojson' }, { id: layerIds.spc.day2.hail, url: 'https://www.spc.no-aa.gov/products/outlook/day2otlk_hail.nolyr.geojson' }, { id: layerIds.spc.day2.wind, url: 'https://www.spc.noaa.gov/products/outlook/day2otlk_wind.nolyr.geojson' },
                { id: layerIds.spc.day3.cat, url: 'https://www.spc.noaa.gov/products/outlook/day3otlk_cat.nolyr.geojson' }, { id: layerIds.spc.day3.prob, url: 'https://www.spc.noaa.gov/products/outlook/day3otlk_prob.nolyr.geojson' }
            ];
            spcSources.forEach(source => map.addSource(source.id, { type: 'geojson', data: source.url }));
            map.addSource('weather-radar', { 'type': 'raster', 'tiles': [`https://mesonet.agron.iastate.edu/cgi-bin/wms/nexrad/n0q.cgi?service=WMS&version=1.1.1&request=GetMap&layers=nexrad-n0q-900913&srs=EPSG:900913&width=256&height=256&format=image/png&transparent=true&bbox={bbox-epsg-3857}&_=${new Date().getTime()}`], 'tileSize': 256 });
            map.addSource('alerts', { type: 'geojson', data: { type: 'FeatureCollection', features: [] } });
            map.addSource('radar-sites', { type: 'geojson', data: 'https://api.weather.gov/radar/stations?stationType=WSR-88D,TDWR' });
            
            updateAlerts();
            
            // --- Add layers in the correct visual order (bottom to top) ---
            // Each layer is inserted 'before' an existing layer ID. We use `firstSymbolId` as the main anchor.
            // The first layer added with this anchor will be at the bottom of the group.

            // 6. SPC Outlooks (Bottom-most)
            spcSources.forEach(source => {
                map.addLayer({ // Add fill layer
                    id: source.id, type: 'fill', source: source.id,
                    paint: { 'fill-color': ['get', 'fill'], 'fill-opacity': 0.3 },
                    layout: { 'visibility': 'none' }
                }, firstSymbolId);
                map.addLayer({ // Add border layer on top of fill
                    id: `${source.id}-border`, type: 'line', source: source.id,
                    paint: { 'line-color': ['get', 'fill'], 'line-width': 2 },
                    layout: { 'visibility': 'none' }
                }, firstSymbolId);
            });

            // 5. IEM Mosaic Radar
            map.addLayer({ 
                id: layerIds.radar, type: 'raster', source: 'weather-radar',
                layout: { 'visibility': document.getElementById('radar-toggle').checked ? 'visible' : 'none' }
            }, firstSymbolId);
            
            // 4. Specific Site Radar is added dynamically on click.

            // 3. Alerts
            const alertFilter = [
                'in', ['get', 'event'],
                ['literal', [ 'Tornado Warning', 'Severe Thunderstorm Warning', 'Severe Weather Statement', 'Special Marine Warning', 'Marine Weather Statement', 'Flash Flood Warning', 'Flash Flood Advisory', 'Flood Warning', 'Flood Advisory', 'Special Weather Statement' ]]
            ];
            const alertColor = [
                'match', ['get', 'event'],
                'Tornado Warning', '#FF0000', 'Severe Thunderstorm Warning', '#FFA500', 'Severe Weather Statement', '#ADD8E6',
                'Special Marine Warning', '#FFFF00', 'Marine Weather Statement', '#FFFF00', 'Flash Flood Warning', '#008080', 'Flash Flood Advisory', '#008080',
                'Flood Warning', '#008000', 'Flood Advisory', '#008000', 'Special Weather Statement', '#ADD8E6', '#808080'
            ];

            map.addLayer({ // Add fill layer
                id: layerIds.alerts, type: 'fill', source: 'alerts', filter: alertFilter,
                paint: { 'fill-color': alertColor, 'fill-opacity': 0.3 },
                layout: { 'visibility': document.getElementById('alerts-toggle').checked ? 'visible' : 'none' }
            }, firstSymbolId);
            map.addLayer({ // Add border layer on top of fill
                id: layerIds.alertsBorder, type: 'line', source: 'alerts', filter: alertFilter,
                paint: { 'line-color': alertColor, 'line-width': 2 },
                layout: { 'visibility': document.getElementById('alerts-toggle').checked ? 'visible' : 'none' }
            }, firstSymbolId);

            // 2. Map Labels are already in place (`firstSymbolId`).
            
            // 1. Radar Sites (Top-most)
            // Add without a 'beforeId' to place it on top of all other layers, including labels.
            map.addLayer({
                id: layerIds.radarSites, type: 'circle', source: 'radar-sites',
                paint: { 
                    'circle-radius': 4, 
                    'circle-stroke-color': 'white', 
                    'circle-stroke-width': 1.5,
                    'circle-color': [ 'match', ['get', 'stationType'], 'WSR-88D', '#0099ff', 'TDWR', '#ff9900', '#808080' ]
                },
                layout: { 'visibility': document.getElementById('radar-sites-toggle').checked ? 'visible' : 'none' }
            });
        }

        function updateTypeDropdown() {
            const day = daySelect.value;
            typeContainer.style.display = (day === 'none') ? 'none' : 'block';
            if (day !== 'none') {
                const types = outlookTypes['day' + day];
                typeSelect.innerHTML = '';
                types.forEach(type => {
                    const option = document.createElement('option');
                    option.value = type.value;
                    option.textContent = type.text;
                    typeSelect.appendChild(option);
                });
            }
        }

        function updateSpcLayerVisibility() {
            if (!map.isStyleLoaded()) return;
            allSpcLayerIds.forEach(id => {
                 if (map.getLayer(id)) map.setLayoutProperty(id, 'visibility', 'none');
            });

            const day = daySelect.value;
            if (day === 'none') return;
            
            const type = typeSelect.value;
            const layerToShow = layerIds.spc['day' + day][type];
            
            if (layerToShow) {
                if (map.getLayer(layerToShow)) {
                    map.setLayoutProperty(layerToShow, 'visibility', 'visible');
                }
                if (map.getLayer(`${layerToShow}-border`)) {
                    map.setLayoutProperty(`${layerToShow}-border`, 'visibility', 'visible');
                }
            }
        }
        
        function handleDayChange() {
            const day = daySelect.value;
            typeContainer.style.display = (day === 'none') ? 'none' : 'block';
            updateTypeDropdown();
            updateSpcLayerVisibility();
        }

        map.on('load', () => {
            handleDayChange();
            daySelect.addEventListener('change', handleDayChange);
            typeSelect.addEventListener('change', updateSpcLayerVisibility);
            
            document.getElementById('radar-toggle').addEventListener('change', (e) => { if (map.getLayer(layerIds.radar)) map.setLayoutProperty(layerIds.radar, 'visibility', e.target.checked ? 'visible' : 'none'); });
            document.getElementById('alerts-toggle').addEventListener('change', (e) => { 
                if (map.getLayer(layerIds.alerts)) map.setLayoutProperty(layerIds.alerts, 'visibility', e.target.checked ? 'visible' : 'none');
                if (map.getLayer(layerIds.alertsBorder)) map.setLayoutProperty(layerIds.alertsBorder, 'visibility', e.target.checked ? 'visible' : 'none');
            });
            document.getElementById('radar-sites-toggle').addEventListener('change', (e) => { if (map.getLayer(layerIds.radarSites)) map.setLayoutProperty(layerIds.radarSites, 'visibility', e.target.checked ? 'visible' : 'none'); });

            document.getElementById('map-style-select').addEventListener('change', (e) => {
                const styleUrl = e.target.value === 'dark' 
                    ? 'https://basemaps.cartocdn.com/gl/dark-matter-gl-style/style.json' 
                    : 'https://basemaps.cartocdn.com/gl/positron-gl-style/style.json';
                map.setStyle(styleUrl);
            });

            setInterval(() => {
                updateAlerts();
                updateRadar();
            }, 60000); 
        });

        map.on('style.load', () => {
            setupMapData();
            handleDayChange(); 
        });
        
        map.on('click', layerIds.radarSites, (e) => {
            e.preventDefault(); 
            const feature = e.features[0];
            const props = feature.properties;
            const clickedStationId = props.id;

            if (activeSiteIdForMenu === clickedStationId) {
                closeActivePopup();
                return;
            }
            
            closeActivePopup();

            const clickedStationIdLower = clickedStationId.toLowerCase();
            if (activeSiteIdForData && activeSiteIdForData !== clickedStationIdLower) {
                removeSingleSiteLayer();
                activeRadarProductCode = null;
                activeSiteIdForData = null;
            }

            activeSiteIdForMenu = clickedStationId;

            const coordinates = feature.geometry.coordinates.slice();
            const name = props.name;
            const stationType = props.stationType;

            let buttonsHtml = '';
            if (stationType === 'WSR-88D') {
                buttonsHtml = `
                    <button onclick="toggleRadarProduct('${clickedStationIdLower}', 'sr_bref')">Reflectivity</button>
                    <button onclick="toggleRadarProduct('${clickedStationIdLower}', 'sr_bvel')">Velocity</button>
                `;
            } else if (stationType === 'TDWR') {
                buttonsHtml = `
                    <button onclick="toggleRadarProduct('${clickedStationIdLower}', 'brefl')">Long Range Reflectivity</button>
                    <button onclick="toggleRadarProduct('${clickedStationIdLower}', 'bref1')">Reflectivity</button>
                    <button onclick="toggleRadarProduct('${clickedStationIdLower}', 'bvel')">Velocity</button>
                `;
            }

            while (Math.abs(e.lngLat.lng - coordinates[0]) > 180) {
                coordinates[0] += e.lngLat.lng > coordinates[0] ? 360 : -360;
            }

            currentPopup = new maplibregl.Popup({ closeOnClick: false, closeButton: false })
                .setLngLat(coordinates)
                .setHTML(`<strong>${clickedStationId} - ${name}</strong><br>${stationType}<hr style="margin: 5px 0;">${buttonsHtml}`)
                .addTo(map);
        });

        map.on('click', (e) => {
            const features = map.queryRenderedFeatures(e.point, { layers: [layerIds.radarSites] });
            if (!features.length) {
                closeActivePopup();
            }
        });

        map.on('mouseenter', layerIds.radarSites, () => { map.getCanvas().style.cursor = 'pointer'; });
        map.on('mouseleave', layerIds.radarSites, () => { map.getCanvas().style.cursor = ''; });

    </script>
</body>
</html>
